<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Debug Scanner - OpenCV</title>
    <style>
        body { margin: 0; background: #000; color: #0f0; font-family: monospace; text-align: center; }
        video, canvas { width: 100%; max-width: 500px; display: block; margin: 0 auto; }
        .debug-view { border: 2px solid red; margin-top: 10px; }
        #info { position: fixed; top: 0; width: 100%; background: rgba(0,0,0,0.8); padding: 10px; z-index: 100; }
    </style>
</head>
<body>

<div id="info">Estado: <span id="msg">Cargando...</span></div>
<video id="v" playsinline muted></video>
<canvas id="debugCanvas" class="debug-view"></canvas>
<canvas id="res" style="width:200px; border:1px solid white;"></canvas>

<script async src="https://docs.opencv.org/4.5.4/opencv.js" onload="init()"></script>

<script>
let src, gray, edge, contours, hier;
const msg = document.getElementById('msg');

function init() {
    msg.innerText = "OpenCV OK. Iniciando cámara...";
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
    .then(s => {
        const v = document.getElementById('v');
        v.srcObject = s;
        v.play();
        v.onloadedmetadata = () => {
            src = new cv.Mat(v.videoHeight, v.videoWidth, cv.CV_8UC4);
            gray = new cv.Mat();
            edge = new cv.Mat();
            contours = new cv.MatVector();
            hier = new cv.Mat();
            loop();
        };
    });
}

function loop() {
    const v = document.getElementById('v');
    const cap = new cv.VideoCapture(v);
    cap.read(src);

    // 1. Convertir a gris y mejorar contraste
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
    
    // 2. Detección de bordes Canny (más directo para debug)
    // Bajamos los umbrales para que detecte HASTA LO MÁS MÍNIMO
    cv.Canny(gray, edge, 50, 150);

    // 3. Engrosar líneas (CRÍTICO para tickets arrugados)
    let M = cv.Mat.ones(3, 3, cv.CV_8U);
    cv.dilate(edge, edge, M); 
    M.delete();

    // MOSTRAMOS EL DEBUG: Si aquí no ves un rectángulo blanco, ajusta la luz
    cv.imshow('debugCanvas', edge);

    // 4. Buscar contornos
    cv.findContours(edge, contours, hier, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

    let found = false;
    for (let i = 0; i < contours.size(); ++i) {
        let cnt = contours.get(i);
        let area = cv.contourArea(cnt);
        
        // Bajamos el área mínima al 5% de la pantalla
        if (area > (src.rows * src.cols * 0.05)) {
            let peri = cv.arcLength(cnt, true);
            let approx = new cv.Mat();
            cv.approxPolyDP(cnt, approx, 0.04 * peri, true); // Aumentamos margen de error

            if (approx.rows === 4) {
                msg.innerText = "¡DETECTADO! Area: " + Math.round(area);
                msg.style.color = "#0f0";
                
                // Dibujar sobre el video original para confirmar
                let color = new cv.Scalar(0, 255, 0, 255);
                cv.drawContours(src, contours, i, color, 2, cv.LINE_8, hier, 0);
                found = true;
                approx.delete();
                break; 
            }
            approx.delete();
        }
    }

    if(!found) {
        msg.innerText = "Buscando... (Mira el cuadro rojo abajo)";
        msg.style.color = "white";
    }

    requestAnimationFrame(loop);
}
</script>
</body>
</html>

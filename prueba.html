<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Scanner Debug - Paso a Paso</title>
    <style>
        body { background: #1a1a1a; color: #fff; font-family: monospace; padding: 20px; text-align: center; }
        .box { border: 2px solid #444; padding: 10px; margin: 10px; border-radius: 8px; }
        #video { width: 320px; background: #000; }
        .ready { color: #0f0; }
        .error { color: #f00; }
    </style>
</head>
<body>

    <div class="box">
        1. Cámara: <span id="camStatus">Esperando permiso...</span><br>
        <video id="video" playsinline muted></video>
    </div>

    <div class="box">
        2. OpenCV: <span id="cvStatus">Descargando librería...</span>
    </div>

    <canvas id="canvasOut"></canvas>

    <script>
        // Paso 1: Forzar inicio de cámara inmediatamente
        const video = document.getElementById('video');
        const camStatus = document.getElementById('camStatus');
        const cvStatus = document.getElementById('cvStatus');

        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(stream => {
                video.srcObject = stream;
                video.play();
                camStatus.innerText = "✅ FUNCIONANDO";
                camStatus.className = "ready";
            })
            .catch(err => {
                camStatus.innerText = "❌ ERROR: " + err.name;
                camStatus.className = "error";
                console.error(err);
            });

        // Paso 2: Función que llamará OpenCV cuando cargue
        function onOpenCvReady() {
            cvStatus.innerText = "✅ CARGADO CORRECTAMENTE";
            cvStatus.className = "ready";
            iniciarProcesamiento();
        }

        function iniciarProcesamiento() {
            let src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
            let gray = new cv.Mat();
            let cap = new cv.VideoCapture(video);

            function loop() {
                try {
                    cap.read(src);
                    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                    // Si llegamos aquí, OpenCV está trabajando
                    cv.imshow('canvasOut', gray);
                } catch (e) {
                    console.log("Esperando frames...");
                }
                requestAnimationFrame(loop);
            }
            loop();
        }
    </script>
    
    <script async src="https://docs.opencv.org/4.5.5/opencv.js" onload="onOpenCvReady()" onerror="cvStatus.innerText='❌ ERROR DE DESCARGA'"></script>

</body>
</html>

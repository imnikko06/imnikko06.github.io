<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Pro Final</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    
    <style>
        /* --- ESTILOS GENERALES --- */
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; touch-action: none; }
        
        /* --- PANTALLA C√ÅMARA --- */
        #camContainer { position: relative; width: 100vw; height: 100vh; background: black; }
        #canvasOut { width: 100%; height: 100%; object-fit: cover; }
        
        #ui-layer { 
            position: absolute; bottom: 30px; left: 0; width: 100%; 
            display: flex; justify-content: center; pointer-events: none; 
        }
        #btnSnap {
            pointer-events: auto;
            background: #ffcc00; width: 70px; height: 70px; border-radius: 50%;
            border: 4px solid #fff; box-shadow: 0 0 15px rgba(255,204,0,0.6);
            cursor: pointer;
        }

        #log { 
            position: absolute; top: 40px; width: 100%; text-align: center;
            color: #ffcc00; text-shadow: 1px 1px 2px #000; font-weight: bold; 
            font-size: 14px; pointer-events: none; z-index: 10;
        }

        /* --- PANTALLA EDITOR (IMPORTANTE) --- */
        #editorScreen {
            display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #111; z-index: 100; flex-direction: column;
        }

        /* El contenedor de la imagen debe ocupar todo el espacio menos la barra de herramientas */
        .crop-container {
            flex: 1; /* Ocupa todo el espacio vertical disponible */
            width: 100%;
            background: #000;
            position: relative;
            overflow: hidden;
        }
        
        /* La imagen dentro del editor (max-width vital para CropperJS) */
        #imageToCrop {
            display: block;
            max-width: 100%;
            max-height: 100%;
        }

        /* Barra de herramientas inferior */
        .toolbar {
            height: 60px; background: #222; display: flex; 
            justify-content: space-between; align-items: center; padding: 10px 20px;
        }
        .toolbar button {
            background: #444; color: white; border: none; padding: 10px 15px;
            border-radius: 5px; font-size: 16px; margin: 0 5px;
        }
        .btn-save { background: #2ecc71 !important; font-weight: bold; }
        .btn-cancel { background: #e74c3c !important; }

        /* --- PANTALLA RESULTADO FINAL --- */
        #finalResultScreen {
            display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 200; flex-direction: column; align-items: center; justify-content: center;
        }
        #finalImage {
            max-width: 90%; max-height: 80%; border: 2px solid #fff; margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <div id="camContainer">
        <div id="log">Iniciando sistema...</div>
        <video id="video" playsinline muted style="display:none"></video>
        <canvas id="canvasOut"></canvas>
        <div id="ui-layer">
            <button id="btnSnap"></button>
        </div>
    </div>

    <div id="editorScreen">
        <div class="crop-container" id="cropContainer">
            </div>
        <div class="toolbar">
            <button class="btn-cancel" id="btnDiscard">‚ùå</button>
            <button id="btnRotL">üîÑ -90¬∞</button>
            <button id="btnRotR">üîÑ +90¬∞</button>
            <button class="btn-save" id="btnSave">‚úÖ Guardar</button>
        </div>
    </div>

    <div id="finalResultScreen">
        <h2 style="color:white">Resultado</h2>
        <img id="finalImage" />
        <br>
        <button class="btn-cancel" onclick="resetApp()" style="padding: 15px 30px; font-size: 18px; border-radius: 8px; border:none; color:white;">üîÑ Nuevo Escaneo</button>
    </div>

    <script src="https://docs.opencv.org/4.8.0/opencv.js" async onload="onOpenCvReady();"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <script>
        // Variables
        const log = (t) => document.getElementById('log').innerText = t;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvasOut');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        
        let src, gray, binary, contours, hierarchy, detectedRotatedRect;
        let isStreaming = false;
        let cropper = null; // Instancia del editor

        function onOpenCvReady() {
            log("üì∑ C√°mara lista.");
            startCamera();
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }
                });
                video.srcObject = stream;
                await video.play();
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                initOpenCV();
                requestAnimationFrame(processVideo);
            } catch (err) {
                log("Error C√°mara: " + err.message);
            }
        }

        function initOpenCV() {
            src = new cv.Mat(canvas.height, canvas.width, cv.CV_8UC4);
            gray = new cv.Mat();
            binary = new cv.Mat();
            contours = new cv.MatVector();
            hierarchy = new cv.Mat();
            isStreaming = true;
        }

        function processVideo() {
            if (!isStreaming) return;
            try {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                let imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                src.data.set(imgData.data);

                // Detecci√≥n de Bloque S√≥lido (Igual que antes)
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                cv.GaussianBlur(gray, gray, new cv.Size(9, 9), 0);
                cv.threshold(gray, binary, 0, 255, cv.THRESH_BINARY | cv.THRESH_OTSU);
                
                let M = cv.Mat.ones(5, 5, cv.CV_8U);
                cv.dilate(binary, binary, M, new cv.Point(-1, -1), 2);
                M.delete();

                cv.findContours(binary, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

                let maxArea = 0;
                let bestCnt = null;
                for (let i = 0; i < contours.size(); ++i) {
                    let cnt = contours.get(i);
                    let area = cv.contourArea(cnt);
                    if (area > 30000) { 
                        if (area > maxArea) { maxArea = area; bestCnt = cnt; }
                    }
                }

                detectedRotatedRect = null;
                if (bestCnt) {
                    detectedRotatedRect = cv.minAreaRect(bestCnt);
                    drawRotatedRect(ctx, detectedRotatedRect);
                    log("‚úÖ Ticket detectado");
                } else {
                    log("üîç Buscando ticket...");
                }
            } catch (e) { console.error(e); }
            requestAnimationFrame(processVideo);
        }

        function drawRotatedRect(ctx, rect) {
            let vertices = cv.RotatedRect.points(rect);
            ctx.beginPath();
            ctx.lineWidth = 6;
            ctx.strokeStyle = "#FFCC00";
            ctx.moveTo(vertices[0].x, vertices[0].y);
            for (let i = 1; i < 4; i++) ctx.lineTo(vertices[i].x, vertices[i].y);
            ctx.closePath();
            ctx.stroke();
        }

        // --- CAPTURA Y LANZAMIENTO DEL EDITOR ---
        document.getElementById('btnSnap').onclick = () => {
            if (!detectedRotatedRect) {
                alert("Ac√©rcate m√°s o busca un fondo oscuro.");
                return;
            }
            isStreaming = false;

            // 1. Enderezar autom√°ticamente con OpenCV antes de editar
            let center = detectedRotatedRect.center;
            let size = detectedRotatedRect.size;
            let angle = detectedRotatedRect.angle;
            
            // Corregir √°ngulo de OpenCV (-90 a 0)
            if (angle < -45) {
                angle += 90;
                let temp = size.width; size.width = size.height; size.height = temp;
            }

            let rotMat = cv.getRotationMatrix2D(center, angle, 1);
            let warped = new cv.Mat();
            
            // Imagen limpia (re-leer del video)
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            let cleanData = ctx.getImageData(0,0,canvas.width, canvas.height);
            let cleanSrc = new cv.Mat(canvas.height, canvas.width, cv.CV_8UC4);
            cleanSrc.data.set(cleanData.data);

            // Warp & Crop
            cv.warpAffine(cleanSrc, warped, rotMat, new cv.Size(canvas.width, canvas.height));
            let finalCrop = new cv.Mat();
            cv.getRectSubPix(warped, size, center, finalCrop);

            // Convertir a DataURL
            let tempCanvas = document.createElement('canvas');
            cv.imshow(tempCanvas, finalCrop);
            let dataUrl = tempCanvas.toDataURL('image/jpeg');

            // Limpieza memoria OpenCV
            rotMat.delete(); warped.delete(); finalCrop.delete(); cleanSrc.delete();

            // 2. ABRIR EDITOR
            startCropper(dataUrl);
        };

        // --- FUNCI√ìN ROBUSTA PARA INICIAR CROPPER ---
        function startCropper(url) {
            // Ocultar c√°mara, mostrar editor
            document.getElementById('camContainer').style.display = 'none';
            document.getElementById('editorScreen').style.display = 'flex';

            const cropContainer = document.getElementById('cropContainer');
            
            // ‚ö†Ô∏è TRUCO CLAVE: Borrar contenido anterior y crear imagen nueva
            cropContainer.innerHTML = ''; 
            const img = document.createElement('img');
            img.id = 'imageToCrop';
            img.src = url;
            cropContainer.appendChild(img);

            // Destruir instancia previa si existe
            if (cropper) { cropper.destroy(); cropper = null; }

            // Iniciar Cropper solo cuando la imagen haya cargado
            // (Aunque con DataURL es casi inmediato, esto evita bugs)
            img.onload = () => {
                cropper = new Cropper(img, {
                    viewMode: 1, // Restringe el recorte al tama√±o del canvas
                    dragMode: 'move', // Permite mover la foto
                    autoCropArea: 0.9,
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                    background: false // Quita el fondo de ajedrez
                });
            };
        }

        // --- BOTONES DEL EDITOR ---
        document.getElementById('btnRotL').onclick = () => { if(cropper) cropper.rotate(-90); };
        document.getElementById('btnRotR').onclick = () => { if(cropper) cropper.rotate(90); };
        document.getElementById('btnDiscard').onclick = resetApp;

        document.getElementById('btnSave').onclick = () => {
            if (!cropper) return;

            // Obtener recorte final
            let canvasResult = cropper.getCroppedCanvas({
                maxWidth: 2048, maxHeight: 2048,
                imageSmoothingEnabled: true, imageSmoothingQuality: 'high'
            });

            // Mostrar pantalla final
            document.getElementById('editorScreen').style.display = 'none';
            document.getElementById('finalResultScreen').style.display = 'flex';
            document.getElementById('finalImage').src = canvasResult.toDataURL('image/jpeg', 0.95);
        };

        function resetApp() {
            // Limpiar todo y volver a c√°mara
            if (cropper) { cropper.destroy(); cropper = null; }
            document.getElementById('editorScreen').style.display = 'none';
            document.getElementById('finalResultScreen').style.display = 'none';
            document.getElementById('camContainer').style.display = 'block'; // Volver a mostrar contenedor flex/block
            isStreaming = true;
            requestAnimationFrame(processVideo);
        }

    </script>
</body>
</html>
